---
- name: Copy SSH public key to remote hosts (handle immutable)
  hosts: all
  become: true
  become_user: root

  vars:
    pubkey: "<your_ssh_public_key_here>"

  tasks:
    - name: Ensure /root/.ssh directory exists
      file:
        path: /root/.ssh
        state: directory
        mode: "0700"

    - name: Remove immutable flag from authorized_keys (if exists)
      ansible.builtin.command: chattr -i /root/.ssh/authorized_keys
      register: remove_chattr
      ignore_errors: true
      changed_when: remove_chattr.rc == 0

    - name: Add public key to root's authorized_keys (idempotent)
      authorized_key:
        user: root
        key: "{{ pubkey }}"
        state: present

    - name: Restore immutable flag on authorized_keys
      ansible.builtin.command: chattr +i /root/.ssh/authorized_keys
      register: restore_chattr
      ignore_errors: true
      changed_when: restore_chattr.rc == 0
