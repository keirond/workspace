---
- name: Configuration Setup
  hosts: all
  become: true
  gather_facts: no

  tasks:
    # Set SeLinux to Permissive Mode
    # <- Because Kubernetes components may not function properly with enforcing mode

    - name: Set SeLinux to Permissive Mode (temporary)
      command: setenforce 0
      ignore_errors: true

    - name: Ensure SeLinux to Permissive Mode (permanently)
      replace:
        path: /etc/selinux/config
        regexp: "^SELINUX=.*$"
        replace: "SELINUX=permissive"

    # Disable Swap on All Nodes
    # <- Because Kubernetes expects predictable memory management

    - name: Disable swap (temporary)
      command: swapoff -a

    - name: Disable swap (permanently)
      replace:
        path: /etc/fstab
        regexp: '^([^#].*[\s\t]swap[\s\t].*)$'
        replace: '# \1'

    - name: Verify swap is disabled
      command: free -h
      register: swap_status

    - name: Display swap status
      debug:
        msg: "{{ swap_status.stdout }}"

    # Kernel Modules and Sysctl Settings
    # <- Required for Kubernetes networking and pod communication

    - name: Enable required kernel modules
      copy:
        dest: /etc/modules-load.d/k8s.conf
        content: |
          overlay
          br_netfilter

    - name: Load kernel modules now
      shell: |
        modprobe overlay
        modprobe br_netfilter

    - name: Set sysctl params
      copy:
        dest: /etc/sysctl.d/k8s.conf
        content: |
          net.bridge.bridge-nf-call-iptables = 1
          net.bridge.bridge-nf-call-ip6tables = 1
          net.ipv4.ip_forward = 1

    - name: Apply sysctl changes
      command: sysctl --system
