---
- name: Install Kubernetes Control Plane
  hosts: master[0]
  become: true
  vars:
    pod_network_cidr: "10.244.0.0/16"

  tasks:
    - name: Initialize Kubernetes Control Plane
      command: kubeadm init --pod-network-cidr={{ pod_network_cidr }}
      args:
        creates: /etc/kubernetes/admin.conf
      register: kubeadm_init
      retries: 3
      delay: 10
      until: kubeadm_init.rc == 0

    - debug:
        var: kubeadm_init.stdout_lines

    - name: Create .kube directory for admin user
      file:
        path: $HOME/.kube
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: 0755

    - name: Copy admin kubeconfig to admin user
      copy:
        src: /etc/kubernetes/admin.conf
        dest: $HOME/.kube/config
        remote_src: yes
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: 0755
