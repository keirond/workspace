---
- name: Ping and collect system information
  hosts: all
  gather_facts: no

  tasks:
    - name: Ping each host
      ansible.builtin.ping:

    - name: Collect system info via shell
      ansible.builtin.shell: |
        total_gb=$(free -g | awk '/Mem:/ {print $2}')
        total_gb=$(( ( (total_gb + 7) / 8 ) * 8 ))
        used_gb=$(free -g | awk '/Mem:/ {print $3}')
        disk_usage=$(df -BG --output=size / | tail -1 | tr -dc '0-9')

        echo "========================"
        echo "===== SYSTEM INFO ======"
        echo "User: $(whoami)"
        echo "Host: $(hostname)"
        echo "IP: $(hostname -I | awk '{print $1}')"
        echo "Uptime: $(uptime -p)"
        echo "OS: $(grep PRETTY_NAME /etc/os-release | cut -d= -f2 | tr -d '\"')"
        echo "CPU: $(nproc) cores - $(lscpu | grep 'Model name' | sed 's/.*: //')"
        echo "RAM: ${total_gb} GB total (approx), ${used_gb} GB used"
        echo "Disk usage: ${disk_usage} GB"
        echo "========================"
      register: sysinfo

    - name: Show system info output
      ansible.builtin.debug:
        msg: "{{ sysinfo.stdout_lines }}"
